<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>C-Tab 添加快捷方式</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      width: 400px;
      min-height: 300px;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f9fafb;
    }
    body.dark {
      background: #1f2937;
      color: #f9fafb;
    }
    .popup-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .page-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      background: #f3f4f6;
    }
    .page-info.dark {
      background: #374151;
    }
    .page-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #3b82f6;
      color: white;
      border-radius: 6px;
      font-size: 16px;
      flex-shrink: 0;
    }
    .page-details {
      flex: 1;
      overflow: hidden;
    }
    .page-title {
      font-weight: 600;
      font-size: 14px;
      color: #1f2937;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .page-title.dark {
      color: #f9fafb;
    }
    .page-url {
      font-size: 12px;
      color: #6b7280;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .page-url.dark {
      color: #9ca3af;
    }
    .category-select {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .category-label {
      font-size: 14px;
      font-weight: 500;
      color: #374151;
    }
    .category-label.dark {
      color: #d1d5db;
    }
    .category-dropdown {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }
    .category-dropdown.dark {
      background: #1f2937;
      border-color: #374151;
      color: #f9fafb;
    }
    .add-button {
      padding: 10px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .add-button:hover {
      background: #2563eb;
    }
    .add-button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .message {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      text-align: center;
    }
    .message.success {
      background: #dcfce7;
      color: #166534;
    }
    .message.error {
      background: #fee2e2;
      color: #991b1b;
    }
    .message.dark.success {
      background: #166534;
      color: #dcfce7;
    }
    .message.dark.error {
      background: #991b1b;
      color: #fee2e2;
    }
  </style>
</head>
<body>
  <div class="popup-container">
    <div class="page-info" id="pageInfo">
      <div class="page-icon">
        <i class="fa-solid fa-globe"></i>
      </div>
      <div class="page-details">
        <div class="page-title" id="pageTitle">加载中...</div>
        <div class="page-url" id="pageUrl">...</div>
      </div>
    </div>

    <div class="category-select">
      <label class="category-label" id="categoryLabel">选择分类：</label>
      <select class="category-dropdown" id="categorySelect">
        <option value="">加载中...</option>
      </select>
    </div>

    <div id="message" class="message" style="display: none;"></div>

    <button class="add-button" id="addButton">添加到 C-Tab</button>
  </div>

  <script>
    // 获取DOM元素
    const pageInfo = document.getElementById('pageInfo');
    const pageTitle = document.getElementById('pageTitle');
    const pageUrl = document.getElementById('pageUrl');
    const categorySelect = document.getElementById('categorySelect');
    const categoryLabel = document.getElementById('categoryLabel');
    const addButton = document.getElementById('addButton');
    const messageEl = document.getElementById('message');

    // 当前页面信息
    let currentPageInfo = null;
    let categories = [];
    let selectedCategoryId = null;

    // 加载主题
    function loadTheme() {
      const theme = localStorage.getItem('theme');
      if (theme === 'dark') {
        document.body.classList.add('dark');
        pageInfo?.classList.add('dark');
        if (pageTitle) pageTitle.classList.add('dark');
        if (pageUrl) pageUrl.classList.add('dark');
        if (categoryLabel) categoryLabel.classList.add('dark');
        if (categorySelect) categorySelect.classList.add('dark');
      }
    }

    // 显示消息
    function showMessage(text, type = 'success') {
      messageEl.textContent = text;
      messageEl.className = `message ${type}${document.body.classList.contains('dark') ? ' dark' : ''}`;
      messageEl.style.display = 'block';

      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 2000);
    }

    // 获取当前标签页信息
    function getCurrentTabInfo() {
      chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
        if (tabs[0]) {
          const tab = tabs[0];
          currentPageInfo = {
            title: tab.title || '未知页面',
            url: tab.url || '',
            favIconUrl: tab.favIconUrl || '',
          };

          if (pageTitle) pageTitle.textContent = currentPageInfo.title;
          if (pageUrl) pageUrl.textContent = currentPageInfo.url;
        }
      });
    }

    // 获取分类列表
    function getCategories() {
      const stored = localStorage.getItem('infinity-categories');
      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          return Array.isArray(parsed) ? parsed : [];
        } catch (error) {
          console.error('解析分类数据失败:', error);
          return [];
        }
      }
      return [];
    }

    // 渲染分类选项
    function renderCategories() {
      categories = getCategories();

      if (!categorySelect) return;

      categorySelect.innerHTML = '';

      if (categories.length === 0) {
        const option = document.createElement('option');
        option.textContent = '暂无分类';
        categorySelect.appendChild(option);
        addButton.disabled = true;
        return;
      }

      categories.forEach((cat) => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        categorySelect.appendChild(option);
      });

      // 默认选中第一个分类
      if (categories.length > 0) {
        selectedCategoryId = categories[0].id;
        categorySelect.value = selectedCategoryId;
      }

      addButton.disabled = false;
    }

    // 添加快捷方式
    function addShortcut() {
      if (!currentPageInfo) {
        showMessage('无法获取页面信息', 'error');
        return;
      }

      if (!categorySelect) return;

      selectedCategoryId = categorySelect.value;
      if (!selectedCategoryId) {
        showMessage('请选择分类', 'error');
        return;
      }

      const stored = localStorage.getItem('infinity-shortcuts');
      let shortcuts = [];
      if (stored) {
        try {
          shortcuts = JSON.parse(stored);
          if (!Array.isArray(shortcuts)) {
            shortcuts = [];
          }
        } catch (error) {
          console.error('解析快捷方式数据失败:', error);
          shortcuts = [];
        }
      }

      // 检查是否已存在相同URL的快捷方式
      const existingShortcut = shortcuts.find(
        s => s.url === currentPageInfo.url && s.category === selectedCategoryId
      );

      if (existingShortcut) {
        showMessage('该快捷方式已存在', 'error');
        return;
      }

      // 创建新快捷方式
      const newShortcut = {
        id: Date.now().toString(),
        title: currentPageInfo.title,
        url: currentPageInfo.url,
        icon: currentPageInfo.favIconUrl || 'fa-globe',
        category: selectedCategoryId,
      };

      // 添加到列表
      shortcuts.push(newShortcut);

      // 保存到 localStorage
      try {
        localStorage.setItem('infinity-shortcuts', JSON.stringify(shortcuts));
        showMessage('添加成功！', 'success');

        // 延迟关闭 popup
        setTimeout(() => {
          window.close();
        }, 800);
      } catch (error) {
        console.error('保存失败:', error);
        showMessage('保存失败，请重试', 'error');
      }
    }

    // 初始化
    function init() {
      loadTheme();
      getCurrentTabInfo();
      renderCategories();

      // 绑定事件
      if (addButton) {
        addButton.addEventListener('click', addShortcut);
      }

      if (categorySelect) {
        categorySelect.addEventListener('change', (e) => {
          selectedCategoryId = e.target.value;
        });
      }
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
